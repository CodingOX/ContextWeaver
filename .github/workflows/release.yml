name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.1) (must have tag v0.1.1)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  build-and-publish:
    name: Build and Publish
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (tag on dispatch)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && format('refs/tags/v{0}', github.event.inputs.version) || github.ref }}

      - name: Resolve release version
        id: rel
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            INPUT="${{ github.event.inputs.version }}"
            VER="${INPUT#v}"
            echo "tag=v$VER" >> "$GITHUB_OUTPUT"
            echo "ver=$VER" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
            echo "ver=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"
          fi

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
          cache: pnpm

      - name: Upgrade npm for Trusted Publishing (OIDC)
        run: |
          npm i -g npm@^11.5.1
          npm -v
          node -v
          pnpm -v

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test

      - name: Build all packages
        run: |
          pnpm build
          pnpm -r build

      - name: Verify versions match tag
        run: |
          VER="${{ steps.rel.outputs.ver }}"
          node - <<'NODE'
          const fs = require('fs');
          const ver = process.env.VER;
          const files = [
            ['@alistar.max/contextweaver', 'package.json'],
            ['@alistar.max/contextweaver-lang-typescript', 'packages/lang-typescript/package.json'],
            ['@alistar.max/contextweaver-lang-kotlin', 'packages/lang-kotlin/package.json'],
            ['@alistar.max/contextweaver-lang-csharp', 'packages/lang-csharp/package.json'],
            ['@alistar.max/contextweaver-lang-cpp', 'packages/lang-cpp/package.json'],
            ['@alistar.max/contextweaver-lang-java', 'packages/lang-java/package.json'],
            ['@alistar.max/contextweaver-lang-ruby', 'packages/lang-ruby/package.json'],
            ['@alistar.max/contextweaver-lang-c', 'packages/lang-c/package.json'],
            ['@alistar.max/contextweaver-lang-php', 'packages/lang-php/package.json'],
            ['@alistar.max/contextweaver-lang-rust', 'packages/lang-rust/package.json'],
            ['@alistar.max/contextweaver-lang-swift', 'packages/lang-swift/package.json'],
            ['@alistar.max/contextweaver-lang-all', 'packages/lang-all/package.json'],
            ['@alistar.max/contextweaver-lang-ts21', 'packages/lang-ts21/package.json'],
            ['@alistar.max/contextweaver-lang-ts22', 'packages/lang-ts22/package.json'],
          ];
          let ok = true;
          for (const [name, file] of files) {
            const pkg = JSON.parse(fs.readFileSync(file, 'utf8'));
            if (pkg.version !== ver) {
              console.error(`${name} version mismatch: ${pkg.version} != ${ver}`);
              ok = false;
            }
          }
          if (!ok) process.exit(1);
          NODE
        env:
          VER: ${{ steps.rel.outputs.ver }}

      - name: Publish packages (plugins first, then main)
        run: |
          set -euo pipefail
          VER="${{ steps.rel.outputs.ver }}"

          publish_if_needed() {
            local PKG="$1"
            local DIR="$2"

            if npm view "$PKG@$VER" version >/dev/null 2>&1; then
              echo "Skip publish: $PKG@$VER already exists"
              return 0
            fi

            echo "Publishing $PKG@$VER from $DIR"
            if [ "$DIR" = "." ]; then
              npm publish --no-git-checks --access public --provenance
            else
              (
                cd "$DIR"
                npm publish --no-git-checks --access public --provenance
              )
            fi
          }

          publish_if_needed "@alistar.max/contextweaver-lang-typescript" "packages/lang-typescript"
          publish_if_needed "@alistar.max/contextweaver-lang-kotlin" "packages/lang-kotlin"
          publish_if_needed "@alistar.max/contextweaver-lang-csharp" "packages/lang-csharp"
          publish_if_needed "@alistar.max/contextweaver-lang-cpp" "packages/lang-cpp"
          publish_if_needed "@alistar.max/contextweaver-lang-java" "packages/lang-java"
          publish_if_needed "@alistar.max/contextweaver-lang-ruby" "packages/lang-ruby"
          publish_if_needed "@alistar.max/contextweaver-lang-c" "packages/lang-c"
          publish_if_needed "@alistar.max/contextweaver-lang-php" "packages/lang-php"
          publish_if_needed "@alistar.max/contextweaver-lang-rust" "packages/lang-rust"
          publish_if_needed "@alistar.max/contextweaver-lang-swift" "packages/lang-swift"
          publish_if_needed "@alistar.max/contextweaver-lang-all" "packages/lang-all"

          # å…¼å®¹å±‚æ’ä»¶ï¼ˆä¿ç•™å‘å¸ƒï¼‰
          publish_if_needed "@alistar.max/contextweaver-lang-ts21" "packages/lang-ts21"
          publish_if_needed "@alistar.max/contextweaver-lang-ts22" "packages/lang-ts22"

          publish_if_needed "@alistar.max/contextweaver" "."

      - name: Create GitHub Release
        if: startsWith(steps.rel.outputs.tag, 'v')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.rel.outputs.tag }}
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## ğŸš€ ContextWeaver ${{ steps.rel.outputs.tag }}

            ### ç‰ˆæœ¬äº®ç‚¹
            - æ”¯æŒ Node.js 24ï¼ˆNode è¦æ±‚ï¼š`>=20 <25`ï¼‰
            - ä¸»åŒ…é»˜è®¤å†…ç½® JavaScript / Python / Go çš„ AST åˆ†ç‰‡èƒ½åŠ›
            - å¯é€‰è¯­è¨€æ’ä»¶æ”¹ä¸º `lang-all`ï¼ˆé»˜è®¤æ¨èï¼‰+ æŒ‰è¯­è¨€åŒ…å®‰è£…

            ### å®‰è£…ä¸»åŒ…
            ```bash
            npm install -g @alistar.max/contextweaver
            # æˆ–
            pnpm add -g @alistar.max/contextweaver
            ```

            ### æ¨èå®‰è£…ï¼ˆå…¨é‡å¯é€‰è¯­è¨€ï¼‰
            ```bash
            npm install -g @alistar.max/contextweaver-lang-all
            ```

            ### æŒ‰éœ€å®‰è£…ï¼ˆç¤ºä¾‹ï¼‰
            ```bash
            npm install -g @alistar.max/contextweaver-lang-typescript
            npm install -g @alistar.max/contextweaver-lang-rust
            ```

            > å…¼å®¹æ’ä»¶ `lang-ts21` / `lang-ts22` ä»å¯å®‰è£…ï¼Œä½†ä¸å†æ¨èæ–°ç”¨æˆ·ä½¿ç”¨ã€‚
            > æœªå®‰è£…æ’ä»¶æ—¶ä¼šè‡ªåŠ¨å›é€€åˆ°çº¯æ–‡æœ¬åˆ†ç‰‡ï¼Œä¸é˜»æ–­ç´¢å¼•æµç¨‹ã€‚
